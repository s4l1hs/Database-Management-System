{% extends "base.html" %}

{% block title %}Greenhouse Gas Emissions{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Greenhouse Gas Emissions</h1>
    <p class="text-muted mb-0">
      Country-based greenhouse gas emission indicators with year and source notes. Filter and sort data to analyze emissions trends.
    </p>
  </div>

  {% if session.get("team_no")|int == 1 %}
    <a href="{{ url_for('ghg.add_ghg') }}" class="btn btn-primary">
      <i class="fa-solid fa-plus"></i> Add New Record
    </a>
  {% endif %}
</div>

<!-- FILTER FORM -->
<form method="get" class="row g-3 mb-3">
  <div class="col-md-4">
    <label class="form-label fw-semibold">Country</label>
    <input
      type="text"
      name="country"
      class="form-control form-control-sm"
      placeholder="e.g. Turkey"
      value="{{ current_country or '' }}"
    />
  </div>

  <div class="col-md-2">
    <label class="form-label fw-semibold">Year</label>
    <input
      type="number"
      name="year"
      class="form-control form-control-sm"
      placeholder="e.g. 2012"
      value="{{ current_year or '' }}"
    />
  </div>

  <div class="col-md-3 d-flex align-items-end gap-2">
    <button type="submit" class="btn btn-sm btn-outline-primary">
      Apply Filter
    </button>
    <a href="{{ url_for('ghg.list_ghg') }}" class="btn btn-sm btn-outline-secondary">
      Clear
    </a>
  </div>
</form>

<!-- SORT PANEL (client-side) -->
<form id="sortForm" class="d-flex flex-wrap gap-3 mb-3">
  <div>
    <label class="form-label fw-semibold">Sort By</label>
    <select id="sortColumn" class="form-select form-select-sm">
      <option value="0">ID</option>
      <option value="1">Country</option>
      <option value="2">Region</option>
      <option value="3">Code</option>
      <option value="4">Indicator</option>
      <option value="5">Unit</option>
      <option value="6">Year</option>
      <option value="7">Value</option>
      <option value="8">Share of Total (%)</option>
      <option value="9">Uncertainty (%)</option>
      <option value="10">Source Notes</option>
    </select>
  </div>

  <div>
    <label class="form-label fw-semibold">Order</label>
    <select id="sortOrder" class="form-select form-select-sm">
      <option value="asc">Ascending</option>
      <option value="desc">Descending</option>
    </select>
  </div>

  <div class="align-self-end">
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applySort()">
      Apply Sort
    </button>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-sm table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width: 60px;">#</th>
        <th style="width: 140px;">Country</th>
        <th style="width: 120px;">Region</th>
        <th style="width: 80px;">Code</th>
        <th style="min-width: 260px;">Indicator</th>
        <th style="min-width: 140px;">Unit</th>
        <th class="text-center" style="width: 80px;">Year</th>
        <th class="text-end" style="width: 110px;">Value</th>
        <th class="text-end" style="width: 120px;">Share of Total (%)</th>
        <th class="text-end" style="width: 120px;">Uncertainty (%)</th>
        <th style="min-width: 180px;">Source Notes</th>
        {% if session.get("team_no")|int == 1 %}
          <th style="width: 130px;">Actions</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for ghg, country, indicator in rows %}
        <tr>
          <td class="text-muted">{{ ghg.row_id }}</td>

          <td class="fw-semibold text-truncate" style="max-width: 140px;" title="{{ country.country_name }}">
            {{ country.country_name }}
          </td>

          <td class="text-truncate" style="max-width: 120px;" title="{{ country.region or '-' }}">
            {{ country.region or '-' }}
          </td>

          <td class="text-uppercase text-muted">{{ country.country_code }}</td>

          <td class="text-truncate" style="max-width: 260px;" title="{{ indicator.indicator_name }}">
            {{ indicator.indicator_name }}
          </td>

          <td class="text-truncate" style="max-width: 140px;" title="{{ indicator.unit_symbol or '-' }}">
            {{ indicator.unit_symbol or '-' }}
          </td>

          <td class="text-center">{{ ghg.year }}</td>

          <td class="text-end">
            {% if ghg.indicator_value is not none %}
              {{ ghg.indicator_value }}
            {% else %}
              <span class="text-muted">n/a</span>
            {% endif %}
          </td>

          <td class="text-end">
            {% if ghg.share_of_total_pct is not none %}
              {{ ghg.share_of_total_pct }}
            {% else %}
              <span class="text-muted">n/a</span>
            {% endif %}
          </td>

          <td class="text-end">
            {% if ghg.uncertainty_pct is not none %}
              {{ ghg.uncertainty_pct }}
            {% else %}
              <span class="text-muted">n/a</span>
            {% endif %}
          </td>

          <td class="text-truncate" style="max-width: 180px;" title="{{ ghg.source_notes or '' }}">
            {{ ghg.source_notes or '' }}
          </td>

          {% if current_role in ['editor', 'admin'] %}
            <td>
              <div class="d-flex gap-1">
                <a
                  href="{{ url_for('ghg.edit_ghg', id=ghg.row_id) }}"
                  class="btn btn-sm btn-outline-secondary"
                >
                  Edit
                </a>
                {% if current_role == 'admin' %}
                  <form
                    action="{{ url_for('ghg.delete_ghg', id=ghg.row_id) }}"
                    method="post"
                    onsubmit="return confirm('Delete this record?');"
                  >
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      Delete
                    </button>
                  </form>
                {% endif %}
              </div>
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
function applySort() {
  const colIndex = parseInt(document.getElementById("sortColumn").value);
  const order = document.getElementById("sortOrder").value;

  const tbody = document.querySelector("table tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const sorted = rows.sort((a, b) => {
    let A = a.children[colIndex].innerText.trim();
    let B = b.children[colIndex].innerText.trim();

    const numA = parseFloat(A);
    const numB = parseFloat(B);
    const isNumeric = !isNaN(numA) && !isNaN(numB);

    if (isNumeric) {
      return order === "asc" ? numA - numB : numB - numA;
    } else {
      return order === "asc" ? A.localeCompare(B) : B.localeCompare(A);
    }
  });

  tbody.innerHTML = "";
  sorted.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
