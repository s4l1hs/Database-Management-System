{% extends "base.html" %}

{% block title %}Energy Indicators{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Energy Usage Indicators</h1>
    <p class="text-muted mb-0">
      Country-based energy indicators with year and source notes.
    </p>
  </div>

  {% if session.get("team_no")|int == 1 %}
    <a href="{{ url_for('energy.add_energy') }}" class="btn btn-primary">
      <i class="fa-solid fa-plus"></i> Add New Record
    </a>
  {% endif %}
</div>

<form id="sortForm" class="d-flex flex-wrap gap-3 mb-3">
  <div>
    <label class="form-label fw-semibold">Sort By</label>
    <select id="sortColumn" class="form-select">
      <option value="0">ID</option>
      <option value="1">Country</option>
      <option value="2">Region</option>
      <option value="3">Code</option>
      <option value="4">Indicator</option>
      <option value="5">Unit</option>
      <option value="6">Year</option>
      <option value="7">Value</option>
      <option value="8">Source Notes</option>
    </select>
  </div>

  <div>
    <label class="form-label fw-semibold">Order</label>
    <select id="sortOrder" class="form-select">
      <option value="asc">Ascending</option>
      <option value="desc">Descending</option>
    </select>
  </div>

  <div class="align-self-end">
    <button type="button" class="btn btn-secondary" onclick="applySort()">
      Apply Sort
    </button>
  </div>
</form>

<table class="table table-striped table-hover align-middle">
  <thead class="table-dark">
    <tr>
      <th>#</th>
      <th>Country</th>
      <th>Region</th>
      <th>Code</th>
      <th>Indicator</th>
      <th>Unit</th>
      <th>Year</th>
      <th>Value</th>
      <th>Source Notes</th>
      {% if session.get("team_no")|int == 1 %}
        <th>Actions</th>
      {% endif %}
    </tr>
  </thead>

  <tbody>
    {# Loop through the dictionary rows returned by Raw SQL #}
    {% for row in rows %}
      <tr>
        <td>{{ row.data_id }}</td>
        <td>{{ row.country_name }}</td>
        <td>{{ row.region or '-' }}</td>
        <td>{{ row.country_code }}</td>
        <td>{{ row.indicator_name }}</td>
        <td>{{ row.unit_symbol or '-' }}</td>
        <td>{{ row.year }}</td>
        <td>{{ row.indicator_value }}</td>
        <td>{{ row.data_source or '' }}</td>

        {% if session.get("team_no")|int == 1 %}
          <td>
            <a
              href="{{ url_for('energy.edit_energy', id=row.data_id) }}"
              class="btn btn-sm btn-outline-secondary me-1"
            >
              Edit
            </a>

            <form
              action="{{ url_for('energy.delete_energy', id=row.data_id) }}"
              method="post"
              style="display:inline-block"
              onsubmit="return confirm('Delete this record?');"
            >
              <button type="submit" class="btn btn-sm btn-outline-danger">
                Delete
              </button>
            </form>
          </td>
        {% endif %}
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script>
function applySort() {
  const colIndex = parseInt(document.getElementById("sortColumn").value);
  const order = document.getElementById("sortOrder").value;

  const tbody = document.querySelector("table tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const sorted = rows.sort((a, b) => {
    let A = a.children[colIndex].innerText.trim();
    let B = b.children[colIndex].innerText.trim();

    const numA = parseFloat(A);
    const numB = parseFloat(B);
    const isNumeric = !isNaN(numA) && !isNaN(numB);

    if (isNumeric) {
      return order === "asc" ? numA - numB : numB - numA;
    } else {
      return order === "asc"
        ? A.localeCompare(B)
        : B.localeCompare(A);
    }
  });

  tbody.innerHTML = "";
  sorted.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
